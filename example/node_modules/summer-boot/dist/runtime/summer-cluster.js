"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var worker_1=require("./worker"),__1=require(".."),logger_1=require("../util/logger"),summer_worker_1=require("./summer-worker"),ip=require("ip"),pkg=require("../../package.json"),args=process.argv.slice(2),SummerCluster=function(){function r(){this.workers=[],logger_1.default.info("[master] node version "+process.version+" summer-boot version "+pkg.version),this.conf=__1.Config.getConfig(),this.agent=new summer_worker_1.default({SUMMER_WORKER_TYPE:worker_1.WorkerType.AGENT,NODE_ENV:"start"===args[0]?"production":"development"}),this.agent.on(worker_1.WorkerMessageType.START_SUCCESS,this.forkWorker.bind(this)),this.agent.on(summer_worker_1.default.WORKER_EXIT,function(){return process.exit()}),this.agent.on(worker_1.WorkerMessageType.START_FAIL,function(r){logger_1.default.error("agent started error "+r.data),process.exit()}),this.agent.on(worker_1.WorkerMessageType.TO_ALL_WORKER,this.agent2worker.bind(this))}return r.prototype.agent2worker=function(e){this.workers.forEach(function(r){return r.send(e)})},r.prototype.worker2agent=function(r){this.agent.send(r)},r.prototype.forkWorker=function(){for(var r=0;r<this.conf.worker;r++)this.fork()},r.prototype.fork=function(){var r=new summer_worker_1.default({SUMMER_WORKER_TYPE:worker_1.WorkerType.WORKER,NODE_ENV:"start"===args[0]?"production":"development"});return r.on(summer_worker_1.default.WORKER_EXIT,this.onWorkerExit.bind(this)),r.once(worker_1.WorkerMessageType.WORKER_LISTEN,this.onWorkerListen.bind(this)),r.on(worker_1.WorkerMessageType.TO_AGENT,this.worker2agent.bind(this)),r},r.prototype.onWorkerListen=function(r,e){this.workers.push(e),this.workers.length===this.conf.worker&&logger_1.default.info("application running hare http://"+ip.address()+":"+r.port)},r.prototype.onWorkerExit=function(e,r,o){var t;this.workers.length===this.conf.worker&&(t=this.workers.findIndex(function(r){return r.worker.process.pid===e.process.pid}),this.workers.splice(t,1),this.fork())},r}();exports.default=SummerCluster;