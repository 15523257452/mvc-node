"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),require("reflect-metadata");var __1=require(".."),container_1=require("../core/container"),index_1=require("../index"),path_to_regexp_1=require("path-to-regexp"),path=require("path"),ParserDecorate=function(){function e(){}return e.parser=function(e){for(var t=e.entries(),a=t.next();!a.done;){var n,r,c,o,i,f,_=a.value[1];"function"==typeof _&&(n=Reflect.hasMetadata(__1.MetaKey.CONTROLLER,_),r=Reflect.hasMetadata(__1.MetaKey.COMPONENT,_),c=Reflect.hasMetadata(__1.MetaKey.INTERCEPTOR_HANDLER,_),o=Reflect.hasMetadata(__1.MetaKey.ERROR_HANDLER,_),n&&this.parseController(_),r&&this.parseService(_),c&&(i=(f=Reflect.getMetadata(__1.MetaKey.INTERCEPTOR_HANDLER,_)).rules,f=f.type,container_1.default.addInterceptor({rules:i,func:_,instance:new _,type:f})),o&&(i=(o=Reflect.getMetadata(__1.MetaKey.ERROR_HANDLER,_)).rules,f=o.type,container_1.default.addInterceptor({rules:i,func:_,instance:new _,type:f}))),a=t.next()}},e.parserAutowrite=function(){container_1.default.findAll(function(e,t){for(var a=t.instance,n=0,r=Reflect.ownKeys(a.__proto__);n<r.length;n++){var c=r[n];if("function"!=typeof a[c]&&Reflect.hasMetadata(__1.MetaKey.INJECT,a,c)){if("string"!=typeof c)return;var o=Reflect.getMetadata("design:type",a,c),i=null;(i=o&&o!==Object?container_1.default.getByType(o):(o=Reflect.getMetadata(__1.MetaKey.INJECT,a,c),container_1.default.getByName(o.name)))?a[c]=i:index_1.Logger.error("inject fail: "+c+", not find in container")}}})},e.parseService=function(e){container_1.default.addService({instance:new e,func:e})},e.parseController=function(e){var i=Reflect.getMetadata(__1.MetaKey.CONTROLLER,e),f=new e;Reflect.ownKeys(f.__proto__).forEach(function(e){var t,a,n,r,c,o;"function"==typeof f[e]&&Reflect.hasMetadata(__1.MetaKey.METHOD,f[e])&&(t=Reflect.getMetadata(__1.MetaKey.METHOD,f[e]),a=path.join(i.path,t.path).replace(/\\/g,"/"),n={},r=[],c=path_to_regexp_1.pathToRegexp(a,r),o=a.replace("/","").split("/").map(function(e){return e.replace(":","")}),r.forEach(function(e){e.name&&(n[e.name]=o.indexOf(e.name))}),container_1.default.add(t.method+":"+a,{instance:f,func:f[e],method:t.method,rules:c,params:n}))})},e}();exports.default=ParserDecorate;